---
# dns role - /etc/hosts management tasks
# Manages custom host entries with proper idempotency
# Skipped when dns_manage_hosts: false (e.g., Docker containers where
# /etc/hosts is bind-mounted and cannot be modified)

# =============================================================================
# Managed Entries Block
# =============================================================================
# Use blockinfile for managed entries to ensure clean add/remove behavior

- name: Manage custom /etc/hosts entries
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE DNS ROLE MANAGED BLOCK"
    block: |
      {% for entry in dns_hosts_entries %}
      {{ entry.ip }}    {{ entry.names | join(' ') }}
      {% endfor %}
    backup: true
    create: false
  when:
    - dns_manage_hosts | bool
    - dns_hosts_entries | length > 0
  tags:
    - dns
    - config
    - hosts

- name: Remove managed block when no entries defined
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE DNS ROLE MANAGED BLOCK"
    block: ""
    state: absent
  when:
    - dns_manage_hosts | bool
    - dns_hosts_entries | length == 0
  tags:
    - dns
    - config
    - hosts

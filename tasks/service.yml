---
# dns role - service management tasks

- name: Check if systemd-resolved is active
  ansible.builtin.command:
    cmd: systemctl is-active systemd-resolved  # noqa: command-instead-of-module
  register: resolved_active
  failed_when: false
  changed_when: false
  check_mode: false
  when: dns_resolved_enabled | bool
  tags:
    - dns
    - service

- name: Start systemd-resolved
  ansible.builtin.command:
    cmd: systemctl start systemd-resolved  # noqa: command-instead-of-module
  changed_when: true
  when:
    - dns_resolved_enabled | bool
    - resolved_active.rc != 0
  tags:
    - dns
    - service

- name: Check if systemd-resolved is enabled
  ansible.builtin.command:
    cmd: systemctl is-enabled systemd-resolved  # noqa: command-instead-of-module
  register: resolved_enabled
  failed_when: false
  changed_when: false
  check_mode: false
  when: dns_resolved_enabled | bool
  tags:
    - dns
    - service

- name: Enable systemd-resolved
  ansible.builtin.command:
    cmd: systemctl enable systemd-resolved  # noqa: command-instead-of-module
  changed_when: true
  when:
    - dns_resolved_enabled | bool
    - resolved_enabled.rc != 0
  tags:
    - dns
    - service

- name: Disable systemd-resolved if disabled
  ansible.builtin.command:
    cmd: systemctl disable --now systemd-resolved  # noqa: command-instead-of-module
  when: not (dns_resolved_enabled | bool)
  changed_when: true
  failed_when: false
  tags:
    - dns
    - service
